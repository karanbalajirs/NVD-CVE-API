from .update import a
from django.http import HttpResponse
from django.shortcuts import render,redirect
from django.core.paginator import Paginator
from .reterive import reterive,reterive_specific
from .decorators import params,admin_required
from math import ceil

@admin_required
def S(request):
    a(request,0)
    return HttpResponse("Fin")

@params
def home(request):
    page = request.page #current page or page to go
    page = int(page)
    lim = request.lim # past limit
    limit = request.limit
    limit = int(limit) #current Limit
    sort = request.sort #sort filter
    sort = int(sort)
    year = request.year #year filter
    rej = request.rej #rejected filter
    cvid = request.cvid #cve-id filter
    lst = request.lst #lastmodified filter
    if lst == '': 
        lst =0
    lst = int(lst)
    print(rej)
    # small request per page to large request per page . To make the data same in the current page after the change of Results per page too 
    if(lim != None and int(lim) < limit ):
        c = int(lim)
        a = max(c,limit)
        b = min(c,limit)
        div = a//b
        page = (page//div)+1
    # large request per page to large request per page . To make the data same in the current page after the change of Results per page too
    if(lim != None and int(lim) > limit):
        c = int(lim)
        a = max(c,limit)
        b = min(c,limit)
        div = a//b
        page = ((page*div)-div)+1
    if(page  < 1 ):
        page = 1
    data,pages = reterive(request,page,limit,sort,year,rej,cvid,lst) #retrieval of data
    count =pages
    pages = pages/limit
    pages= ceil(pages)
    if(page > pages):
        page = pages
    if (year.isalpha()):
        return HttpResponse("Wrong Year")
    print(pages)
    return render(request,'home.html',{'data':data,'pageh':[page-1,page,page+1],'limith':limit,'pages':pages,'count':count,'sort':sort,'year':year,'lenyear':len(year),'rej':rej,'cvid':cvid,'lst':lst})


def cve(request,id):
    c = reterive_specific(request,id)
    return render(request,'cve.html',{'cve':c[0]})