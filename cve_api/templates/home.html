{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
        <script src="{% static 'js/bootstrap.min.js' %}"></script>
        <style>
          .clickable-head{
            cursor: pointer;
          }
        </style>
        <script>   
        
        document.addEventListener("DOMContentLoaded", function() {
        //Request Per Page Change
        document.getElementById("limit").addEventListener("change", function() {
          document.getElementById("cvid1").value = '{{cvid}}';
          document.getElementById("rej").value = '{{rej}}'
          document.getElementById("year1").value = '{{year}}';  
          document.getElementById("page").value = '{{ pageh.1 }}'
          document.getElementById("sort").value = '{{sort}}';
          document.getElementById("lst").value = "{{lst}}"; 
          document.getElementById("form").submit(); //Passing all data back using form in Post to retain the same values in the server for getting the same page after mild filters
        });
        
         //Second Page Selection
        var rows = document.querySelectorAll(".clickable-row");

        rows.forEach(function(row) {
            row.addEventListener("click", function() {
                window.location = row.dataset.href;
            });
        });
        
        //Rejected Toggle
        var clicks = document.getElementById("rs");
        clicks.addEventListener("click",function(){
              var value = this.getAttribute('data-rej');
              document.getElementById("cvid1").value = '{{cvid}}';
              document.getElementById("rej").value = value;
              document.getElementById("year1").value = '{{year}}'; //Passing all data back using form in Post to retain the same values in the server
              document.getElementById("page").value = '1';
              document.getElementById("sort").value = '{{sort}}';
              document.getElementById("lst").value = "{{lst}}";
              document.getElementById("form").submit();
          });

        //Year Filter
        var searchButton = document.getElementById("search-button");
        searchButton.addEventListener("click", function() {
        // Get the value from the input field
        var s = document.getElementById("year").value;
        document.getElementById("cvid1").value = '0';
        document.getElementById("rej").value = '{{rej}}';  //Passing all data back using form in Post to retain the same values in the server  
        document.getElementById("year1").value = s;
        document.getElementById("page").value = '1';
        document.getElementById("sort").value = '{{sort}}';
        document.getElementById("lst").value = "0";
        document.getElementById("form").submit();
        });

        //Search CVE-ID
        var searchBut = document.getElementById("search-cv");
        searchBut.addEventListener("click", function() {
        // Get the value from the input field
        var s = document.getElementById("cvid").value;
        document.getElementById("rej").value = '{{rej}}';
        document.getElementById("cvid1").value = s;
        document.getElementById("year1").value = '0';
        document.getElementById("page").value = '1'; //Passing all data back using form in Post to retain the same values in the server
        document.getElementById("sort").value = '{{sort}}';
        document.getElementById("lst").value = '0';
        document.getElementById("form").submit();
        });

        //Search lastmodified filter
        var searchlsm = document.getElementById("search-lsm");
        searchlsm.addEventListener("click", function() {
        // Get the value from the input field
        var s = document.getElementById("lsm").value;
        if (s == '')
          s= '0'
        document.getElementById("rej").value = '{{rej}}';
        document.getElementById("cvid1").value = '0';
        document.getElementById("year1").value = '0';
        document.getElementById("page").value = '1';  //Passing all data back using form in Post to retain the same values in the server
        document.getElementById("sort").value = '{{sort}}';
        document.getElementById("lst").value = s;
        document.getElementById("form").submit();
        });

        //sort 
        var head = document.querySelectorAll(".clickable-head");
        head.forEach(function(hea){
          hea.addEventListener("click",function(){
            
            var value = this.getAttribute("data-head");
            if(value == null)
            value = 0;
            document.getElementById("cvid1").value = '{{cvid}}';
            document.getElementById("rej").value = '{{rej}}';    //Passing all data back using form in Post to retain the same values in the server
            document.getElementById("year1").value = '{{year}}';
            document.getElementById("page").value = '{{pageh.1}}'
            document.getElementById("sort").value= value;
            document.getElementById("lst").value = "{{lst}}";
            document.getElementById("form").submit();
          })
        });

        //pagination 
        var lis = document.querySelectorAll("#pagination li");
        lis.forEach(function(li) {
            li.addEventListener("click", function() {
                
                var value = this.getAttribute("data-value");
                if (value == null) return;

                li.classList.remove('active');
                this.classList.add('active');

                setTimeout(function(){
                document.getElementById("cvid1").value = '{{cvid}}';
                document.getElementById("rej").value = '{{rej}}';
                document.getElementById("year1").value = '{{year}}';  //Passing all data back using form in Post to retain the same values in the server
                document.getElementById("page").value = value;
                document.getElementById("sort").value = '{{sort}}'
                document.getElementById("lst").value = "{{lst}}";
                document.getElementById("form").submit();
            },100);
          });
        });

        //coloring numbers
        var score  = document.querySelectorAll(".ari")
            score.forEach(function(cell){
                var priority = cell.innerText.trim();
            if( priority < 4.0 && priority >= 0.1)
                cell.classList.add("text-primary");
            else if( priority < 7.0 && priority >= 4.0 )
                cell.classList.add("text-warning");
            else if( priority >= 7.0)
                cell.classList.add("text-danger");
            });
    });
        </script>
    </head>
    <body>
        <center><h1 style="margin-top: 20px;">CVE LIST</h1></center><br>
        <div class="container-fluid">
          <div class="row justify-content-center">
          <div class="col-md-2">
            <h6> <b>Total Records: </b> <span>{{count}}</span> <br> <b> Total Number of Pages:</b> {{pages}}</h6>
          </div>
            <div class="col-md-2">
              <div class="input-group mb-3">
                <!-- Check Whether the CVE-ID is already Present -->
                {% if cvid != '0' and cvid != '' %}
                <input type="text" class="form-control" placeholder="Search CVE-ID" id="cvid" aria-label="Search" aria-describedby="search-button" maxlength="13" value="{{cvid}}">
                {% else %}
                <input type="text" class="form-control" placeholder="Search CVE-ID" id="cvid" aria-label="Search" aria-describedby="search-button" maxlength="13">
                {% endif %}
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="search-cv">Search</button>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="input-group mb-3">
                <!-- Check Whether the YEAR is already Present -->
                {% if year != '0' %}
                <input type="text" class="form-control" placeholder="Search Year" id="year" aria-label="Search" aria-describedby="search-button" minlength="4" maxlength="4" value="{{year}}">
                {% else %}
                <input type="text" class="form-control" placeholder="Search Year" id="year" aria-label="Search" aria-describedby="search-button" minlength="4" maxlength="4">
                {% endif %}
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="search-button">Search</button>
                </div>
              </div>
            </div>
            <div class="col-md-2">
              <div class="input-group mb-3">
                <!-- Check Whether the Last Modified is already Present -->
                {% if lst != 0 %}
                <input type="number" class="form-control" placeholder="Last Modified Before Days" id="lsm" aria-label="Search" aria-describedby="search-button" max=1000 min=0 value="{{lst}}" >
                {% else %}
                <input type="number" class="form-control" placeholder="Last Modified Before Days" id="lsm" aria-label="Search" aria-describedby="search-button" max=1000 min=0>
                {% endif %}
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" id="search-lsm">Search</button>
                </div>
              </div>
            </div>
            {% if rej == 'True' %}
            <div class="col-md-1">
              <h6> <b>Rejected:</b> <span>Not Present</span> </h6>
            </div>
            {% elif  rej != 'True' %}
            <div class="col-md-1">
              <h6> <b>Rejected :</b> <span>Present</span> </h6>
            </div>
            {% endif %}
            {% if lenyear == 4 %}
            <div class="col-md-1">
              <h6> <b>Applied Year: </b> <span>{{year}}</span> </h6>
            </div>
            {% elif lenyear != 4 %}
            <div class="col-md-1">
              <h6> <b>Applied Year: </b> <span>None</span> </h6>
            </div>
            {% endif %}
            {% if cvid != '0' and cvid != "" %}
            <div class="col-md-1">
              <h6> <b>Applied Filter CVE-ID: </b> <span>{{cvid}}</span> </h6>
            </div>
            {% else %}
            <div class="col-md-1">
              <h6> <b>Applied Filter CVE-ID: </b> <span>None</span> </h6>
            </div>
            {% endif %}
            {% if lst != 0 %}
            <div class="col-md-1">
              <h6> <b>Last Modified Before Days: </b> <span>{{lst}}</span> </h6>
            </div>
            {% else %}
            <div class="col-md-1">
              <h6> <b>Last Modified Before Days:</b> <span>None</span> </h6>
            </div>
            {% endif %}
          </div>
            <table class="table table-bordered table-hover">
                <!-- Check Whether the SORT is already Present -->
                <thead >
                    <tr>
                        <th scope="col" >Serial No</th>
                        {% if sort != 1 and sort != -1 %}
                        <th scope="col" data-head="1" class = "clickable-head">CVE ID</th>
                        <th scope="col">Identifier</th>
                        {% elif sort == 1 %}
                        <th scope="col" data-head="-1" class="table-success clickable-head"">CVE Id</th>
                        <th scope="col">Identifier</th>
                        {% elif sort == -1 %}
                        <th scope="col" data-head="0"  class="table-danger clickable-head"">CVE Id</th>
                        <th scope="col">Identifier</th>
                        {% endif %} 
                        {% if sort != 2 and sort != -2%}
                        <th scope="col" data-head="2" class="clickable-head"">Published Date</th>
                        {% elif sort == 2 %}
                        <th scope="col" data-head="-2" class="table-success clickable-head"">Published Date</th>
                        {% elif sort == -2 %}
                        <th scope="col" data-head="0" class="table-danger clickable-head"">Published Date</th>
                        {% endif %}
                        {% if sort != 3 and sort != -3%}
                        <th scope="col" data-head="3" class="clickable-head"">Last Modified Date</th>
                        {% elif sort == 3 %}
                        <th scope="col" data-head="-3" class="table-success clickable-head"">Last Modified Date</th>
                        {% elif sort == -3 %}
                        <th scope="col" data-head="0" class="table-danger clickable-head"">Last Modified Date</th>
                        {% endif %}
                        {% if sort != 4 and sort != -4 %}
                        <th scope="col" data-head="4" class="clickable-head"">Base Score</th>
                        {% elif sort == 4 %}
                        <th scope="col" data-head="-4" class="table-success clickable-head"">Base Score</th>
                        {% elif sort == -4 %}
                        <th scope="col" data-head="0" class="table-danger clickable-head"">Base Score</th>
                        {% endif %}
                        <th scope="col">Vuln Status</th>
                    </tr>
                </thead>
                <tbody>
                    
                    {% for i in data %}
                        <tr class="clickable-row" data-href="/cves/{{i.id}}" style="cursor: pointer;">
                            <td>{{ forloop.counter }}</td>
                            <td>{{ i.id }}</td>
                            <td>{{ i.sourceIdentifier }}</td>
                            <td>{{ i.published }}</td>
                            <td>{{ i.lastModified }}</td>
                            {% if i.metrics2 != null %}
                            <td class="ari">{{ i.metrics2.cvssMetricV2.0.cvssData.baseScore }}</td>
                            {% elif i.metrics30 != null %}
                            <td class="ari">{{ i.metrics30.cvssMetricV30.0.cvssData.baseScore }}</td>
                            {% elif i.metrics31 != null %}
                            <td class="ari">{{ i.metrics31.cvssMetricV31.0.cvssData.baseScore }}</td>
                            {% else %}
                            <td>Null</td>
                            {% endif %}
                            {% if i.vulnStatus == 'Modified' %}
                            <td class="bg-warning">{{ i.vulnStatus }}</td>
                            {% elif i.vulnStatus == 'Analyzed' %}
                            <td class="bg-success">{{ i.vulnStatus }}</td>
                            {% elif i.vulnStatus == 'Rejected' %}
                            <td class="bg-danger">{{ i.vulnStatus }}</td>
                            {% elif i.vulnStatus == 'Received' %}
                            <td class="bg-primary">{{ i.vulnStatus }}</td>
                            {% else %}
                            <td class="bg-info">{{ i.vulnStatus }}</td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                    {% if data.0 == null %}
                    <h4>No Data Found</h4>
                    {% endif %}
                </tbody>
            </table>
        </div>
        <div class="container-fluid">
          <div class="row">
            <div class="col">
              <form action="/cves/list" method="post" id="form">
                {% csrf_token %}
                <input type="hidden" name="lim" id="lim" value="{{limith}}">  
                <input type="hidden" name="sort" id="sort" value="{{sort}}" >
                <input type="hidden" name="year1" id="year1" value="{{year}}">
                <input type="hidden" name="rej" id="rej" value="{{rej}}">
                <input type="hidden" name="cvid1" id="cvid1" value="{{cvid}}">
                <input type="hidden" name="lst" id="lst" value="{{lst}}">
                <div class="form-group row">
                      <label for="resultsPerPage" class="col-sm-4 col-form-label">Results Per Page:</label>
                      <div class="col-sm-4">
                        <!-- Records per page selected change based on post value -->
                          <select class="form-control" id="limit" name="limit" onchange="submitForm()">
                              {% if limith == 10 %}
                              <option value="10" selected>10</option>
                              <option value="50">50</option>
                              <option value="100">100</option>
                              {% elif limith == 50 %}
                              <option value="10">10</option>
                              <option value="50" selected>50</option>
                              <option value="100">100</option>
                              {% elif limith == 100 %}
                              <option value="10">10</option>
                              <option value="50">50</option>
                              <option value="100" selected>100</option>
                              {% endif %}
                              
                          </select>
                      </div>
                  </div>
              
          </div>
          <div class="col">
          <div class="container-fluid">
            <div class="row">
          <div class="col">
            <form action="/cves/list" method="post" >
              <div class="form-group">
              <input type="number" class="form-control" placeholder="Go to Page:" name="page" id="page"  max={{pages}} min="1" required>
            </div>
          </div>
          <div class="col">
          <button type="submit" class="btn btn-primary" >GO</button></div>
        </div>
        </div>
        </div>
        </form>
          <div class="col">
            {% if rej == 'True' %}
            <button type="button" class="btn btn-primary form-control" class=".clickable" id='rs' data-rej = "False">Rejected Removed</button>
            {% else %}
            <button type="button" class="btn btn-outline-primary form-control" class=".clickable" id= 'rs' data-rej="True" >Rejected not Removed</button>
            {% endif %}
          </div>
          <div class = "col">
              <nav aria-label="Page">
                
                  <ul class="pagination justify-content-end" id="pagination">
                <!-- Before or Previous -->
                    {% if pageh.0 == 0 %}
                    <li class="page-item disabled" style="cursor: not-allowed;">
                      <a class="page-link">Previous</a>
                    </li>
                  {% endif %}
                  {% if pageh.0 > 0 %}
                    <li class="page-item " data-value="{{pageh.0}}" style="cursor: pointer;">
                      <a class="page-link">Previous</a>
                    </li>
                  {% endif %}
                <!-- Current -->
                    <li class="page-item active" style="cursor: pointer;"><a class="page-link">{{ pageh.1 }}</a></li>
                  {% if pageh.2 <= pages %}
                    <li class="page-item " data-value="{{pageh.2}}" style="cursor: pointer;">
                      <a class="page-link">Next </a>
                    </li>
                  {% endif %}
                <!-- Next or After -->
                  {% if pageh.2 > pages %}
                  <li class="page-item disabled" style="cursor: not-allowed" >
                    <a class="page-link">Next </a>
                  </li>
                {% endif %}
                  </ul></nav>
              </div>
        </form>
        </div>
      </div>
    </body>
</html>